#pragma once

#include <cmath>
#include <cstring>
#include <cstdio>

#define LIGHTSPECTRUM_MIN_WAVELENGTH 336
#define LIGHTSPECTRUM_MAX_WAVELENGTH 1020
#define LIGHTSPECTRUM_NUM_BINS_BASE 343
// flux, corrected flux, total energy, corrected total energy, photometry, temperature, temperature count
#define LIGHTSPECTRUM_NUM_BINS_TOTAL (LIGHTSPECTRUM_NUM_BINS_BASE * 2 + 7)
#define LIGHTSPECTRUM_CORRECTED_FLUX_INDEX LIGHTSPECTRUM_NUM_BINS_BASE
#define LIGHTSPECTRUM_TOTAL_ENERGY_INDEX (LIGHTSPECTRUM_NUM_BINS_BASE * 2)
#define LIGHTSPECTRUM_CORRECTED_TOTAL_ENERGY_INDEX ((LIGHTSPECTRUM_NUM_BINS_BASE * 2) + 1)
#define LIGHTSPECTRUM_RP_INDEX ((LIGHTSPECTRUM_NUM_BINS_BASE * 2) + 2)
#define LIGHTSPECTRUM_G_INDEX ((LIGHTSPECTRUM_NUM_BINS_BASE * 2) + 3)
#define LIGHTSPECTRUM_BP_INDEX ((LIGHTSPECTRUM_NUM_BINS_BASE * 2) + 4)
#define LIGHTSPECTRUM_TEMPERATURE_INDEX ((LIGHTSPECTRUM_NUM_BINS_BASE * 2) + 5)
#define LIGHTSPECTRUM_TEMPERATURE_COUNT_INDEX ((LIGHTSPECTRUM_NUM_BINS_BASE * 2) + 6)

#define LIGHTSPECTRUM_OUT_OF_RANGE (9999)


class LightSpectrum {

public:
	LightSpectrum();

	double getTotalEnergy() const;
	double getCorrectedTotalEnergy() const;
    double getTemperature() const;
    double getRP() const;
    double getG() const;
    double getBP() const;
    double getTemperatureCount() const;

    void print();

	//inline void reset() { memset(_histogram, 0, sizeof(_histogram)); _totalEnergy = 0.f; }
	LightSpectrum operator+(const LightSpectrum& b);
	LightSpectrum operator-(const LightSpectrum& b);
	LightSpectrum & operator+=(const LightSpectrum& b);
	LightSpectrum & operator-=(const LightSpectrum& b);

    const double* getHistogram() const;

    bool addPhotometry(double rp, double g, double bp);
    bool addTemperature(double temperature);
	bool addFlux(const double b[], const double azero);

private:
	double _histogram[LIGHTSPECTRUM_NUM_BINS_TOTAL] = { 0.f };
};

const double EXTINCTION_CURVE[] = {1.62956885, 1.62197018, 1.6144913 , 1.60712581, 1.59986762,
                                   1.59271096, 1.58565038, 1.57868068, 1.57179698, 1.56499461,
                                   1.55826918, 1.55161651, 1.54503265, 1.53851386, 1.53205659,
                                   1.52565747, 1.51931334, 1.51302117, 1.50677811, 1.50058146,
                                   1.49442868, 1.48831733, 1.48224513, 1.47620991, 1.47020964,
                                   1.46424236, 1.45830626, 1.45239959, 1.44652073, 1.44066813,
                                   1.43484034, 1.42903597, 1.42325373, 1.41749239, 1.4117508 ,
                                   1.40602786, 1.40032255, 1.39463391, 1.38896095, 1.383301  ,
                                   1.37764981, 1.37200333, 1.36635774, 1.36070943, 1.35505502,
                                   1.34939135, 1.34371542, 1.33802445, 1.33231582, 1.32658709,
                                   1.32083596, 1.3150603 , 1.30925813, 1.3034276 , 1.29756698,
                                   1.29167468, 1.28574923, 1.27978927, 1.27379355, 1.2677609 ,
                                   1.26169028, 1.25558072, 1.24943135, 1.24324138, 1.23701009,
                                   1.23073685, 1.22442123, 1.21806606, 1.21167724, 1.20526052,
                                   1.19882142, 1.19236518, 1.18589684, 1.17942119, 1.17294281,
                                   1.16646605, 1.1599951 , 1.15353392, 1.1470863 , 1.14065584,
                                   1.13424598, 1.12785999, 1.12150099, 1.11517193, 1.10887562,
                                   1.10261475, 1.09639186, 1.09020934, 1.08406949, 1.07797448,
                                   1.07192635, 1.06592705, 1.05997841, 1.05408217, 1.04823995,
                                   1.04245332, 1.03672371, 1.03105249, 1.02544095, 1.01989029,
                                   1.01440164, 1.00897605, 1.00361451, 0.99831792, 0.99308715,
                                   0.98792298, 0.98282607, 0.97779537, 0.9728282 , 0.96792194,
                                   0.96307402, 0.95828197, 0.95354342, 0.94885605, 0.94421764,
                                   0.93962605, 0.9350792 , 0.93057508, 0.92611176, 0.92168738,
                                   0.91730013, 0.91294827, 0.90863011, 0.90434404, 0.90008849,
                                   0.89586195, 0.89166295, 0.8874901 , 0.88334203, 0.87921743,
                                   0.87511505, 0.87103365, 0.86697207, 0.86292938, 0.85890544,
                                   0.85490036, 0.85091419, 0.84694701, 0.84299888, 0.83906985,
                                   0.83515997, 0.83126928, 0.82739782, 0.82354562, 0.81971271,
                                   0.8158991 , 0.81210481, 0.80832986, 0.80457425, 0.80083798,
                                   0.79712105, 0.79342346, 0.7897452 , 0.78608625, 0.7824466 ,
                                   0.77882622, 0.7752251 , 0.77164321, 0.76808052, 0.76453699,
                                   0.7610126 , 0.7575073 , 0.75402105, 0.75055381, 0.74710554,
                                   0.74367619, 0.7402657 , 0.73687403, 0.73350112, 0.73014692,
                                   0.72681137, 0.72349441, 0.72019598, 0.71691602, 0.71365446,
                                   0.71041124, 0.70718629, 0.70397955, 0.70079093, 0.69762039,
                                   0.69446783, 0.69133319, 0.6882164 , 0.68511738, 0.68203606,
                                   0.67897236, 0.67592619, 0.6728975 , 0.66988618, 0.66689217,
                                   0.66391539, 0.66095576, 0.65801319, 0.6550876 , 0.65217891,
                                   0.64928704, 0.6464119 , 0.64355342, 0.6407115 , 0.63788607,
                                   0.63507704, 0.63228432, 0.62950783, 0.62674749, 0.62400321,
                                   0.6212749 , 0.61856248, 0.61586587, 0.61318497, 0.61051971,
                                   0.60786999, 0.60523573, 0.60261685, 0.60001326, 0.59742487,
                                   0.5948516 , 0.59229337, 0.58975008, 0.58722165, 0.584708  ,
                                   0.58220904, 0.57972469, 0.57725486, 0.57479946, 0.57235842,
                                   0.56993165, 0.56751906, 0.56512057, 0.56273609, 0.56036556,
                                   0.55800887, 0.55566594, 0.55333671, 0.55102107, 0.54871896,
                                   0.54643028, 0.54415496, 0.54189292, 0.53964407, 0.53740833,
                                   0.53518563, 0.53297588, 0.53077901, 0.52859493, 0.52642357,
                                   0.52426484, 0.52211867, 0.51998499, 0.51786371, 0.51575475,
                                   0.51365804, 0.51157351, 0.50950107, 0.50744066, 0.50539219,
                                   0.50335559, 0.50133079, 0.49931771, 0.49731628, 0.49532642,
                                   0.49334806, 0.49138114, 0.48942557, 0.48748128, 0.48554821,
                                   0.48362628, 0.48171542, 0.47981556, 0.47792664, 0.47604857,
                                   0.4741813 , 0.47232475, 0.47047886, 0.46864356, 0.46681877,
                                   0.46500444, 0.46320049, 0.46140687, 0.45962349, 0.45785031,
                                   0.45608725, 0.45433424, 0.45259124, 0.45085816, 0.44913494,
                                   0.44742153, 0.44571787, 0.44402387, 0.4423395 , 0.44066468,
                                   0.43899935, 0.43734345, 0.43569693, 0.43405972, 0.43243176,
                                   0.43081299, 0.42920336, 0.4276028 , 0.42601126, 0.42442867,
                                   0.42285499, 0.42129015, 0.41973411, 0.41818679, 0.41664815,
                                   0.41511813, 0.41359667, 0.41208372, 0.41057923, 0.40908314,
                                   0.4075954 , 0.40611595, 0.40464474, 0.40318173, 0.40172684,
                                   0.40028005, 0.39884128, 0.3974105 , 0.39598764, 0.39457267,
                                   0.39316552, 0.39176616, 0.39037452, 0.38899056, 0.38761424,
                                   0.3862455 , 0.38488429, 0.38353057, 0.38218429, 0.3808454 ,
                                   0.37951386, 0.37818961, 0.37687262, 0.37556283, 0.3742602 ,
                                   0.37296469, 0.37167624, 0.37039482, 0.36912039, 0.36785289,
                                   0.36659228, 0.36533852, 0.36409156};